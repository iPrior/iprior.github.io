<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <title>Repeater :: WebRTC</title>
</head>
<body>

<div class="container">
    <h1>Repeater :: WebRTC</h1>
    <div class="row" id="containerConnection">
        <div class="col">
            <form>
                <div class="mb-3">
                    <label for="inpSignalingUrl" class="form-label">Signaling</label>
                    <input type="text" class="form-control" id="inpSignalingUrl" value="wss://tididi.ru/webrtc/webinar/1">
                </div>
                <div class="mb-3">
                    <label for="inpToken" class="form-label">Token</label>
                    <input type="text" class="form-control" id="inpToken" value="student">
                </div>
                <button type="button" id="btnConnect" class="btn btn-outline-primary">Connect</button>
            </form>
        </div>
    </div>
    <div class="row" id="localVideoContainer"></div>
    <div class="row" id="remoteVideoContainer"></div>
</div>

<!-- Optional JavaScript; choose one of the two! -->

<!-- Option 1: Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

<!-- Option 2: Separate Popper and Bootstrap JS -->
<!--
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js" integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
-->

<script type="text/javascript">

    class signaling {
        connect(url) {
            let that = this
            this.ws = new WebSocket(url)
            this.ws.onerror = (e) => {
                console.error('websocket error', e)
                if (that.wsOnError != null) {
                    that.wsOnError(e)
                }
            }
            this.ws.onopen = (e) => {
                console.info('websocket successful')
                if (that.wsOnOpen != null) {
                    that.wsOnOpen(e)
                }
            }

            this.ws.onmessage = (e) => {
                let data = JSON.parse(e.data)
                console.info('<- inc [WS]', e.data)
                console.info('<- inc [WS]', data)
                if (that.wsOnMessage != null) {
                    that.wsOnMessage(data)
                }
            }
        }

        send(data) {
            let msg = JSON.stringify(data)
            console.log('-> out [WS]', msg)
            console.log('-> out [WS]', data)
            this.ws.send(msg)
        }

        close() {
            this.ws.close()
        }

        set onMessage(callback) {
            this.wsOnMessage = callback
            return this
        }

        set onSignalingSuccess(callback) {
            this.wsOnOpen = callback
            return this
        }

        set onSignalingError(callback) {
            this.wsOnError = callback
            return this
        }
    }

    class rtcPC {
        constructor(member, conf, onIceCandidateCallback, onTrackCallback, localMediaStream) {
            this.candidateBuf = []
            this.member = member

            this.rtcCon = new RTCPeerConnection(conf)
            this.rtcCon.onconnectionstatechange = this.logEvent()
            this.rtcCon.ondatachannel = this.logEvent()
            this.rtcCon.oniceconnectionstatechange = this.logEvent()
            this.rtcCon.onicegatheringstatechange = this.logEvent()
            this.rtcCon.onsignalingstatechange = this.logEvent()

            let that = this
            this.rtcCon.onicecandidateerror = (e) => {
                let log = that.logEvent()
                log(e)
                console.error('onICECandidateError', JSON.stringify(e), e)
            }
            this.rtcCon.onnegotiationneeded = (e) => {
                let log = that.logEvent()
                log(e)

                // console.info("candidate buffer", this.candidateBuf)
                // if (e.target.signalingState === "have-local-offer") {
                //     let list = this.candidateBuf
                //     that.candidateBuf = []
                //     console.log("accept candidates", list)
                //     list.forEach((candidate) => {
                //         this.rtcCon.addIceCandidate(new RTCIceCandidate(candidate)).catch(console.error)
                //     })
                // }
            }

            this.rtcCon.onicecandidate = (e) => {
                let log = that.logEvent()
                log(e)
                onIceCandidateCallback(e)
            }
            this.rtcCon.ontrack = (e) => {
                let log = that.logEvent()
                log(e)
                onTrackCallback(e)
            }

            if (localMediaStream) {
                console.info("ADD TRANSCEIVER")
                this.rtcCon.addStream(localMediaStream)
                // this.rtcCon.addTransceiver(localMediaStream.getVideoTracks()[0], {
                //     direction: 'sendonly',
                //     streams: [localMediaStream]
                // })
                // this.rtcCon.addTransceiver('video')
                //
                // this.rtcCon.addTransceiver(localMediaStream.getAudioTracks()[0], {
                //     direction: 'sendonly',
                //     streams: [localMediaStream]
                // })
                // this.rtcCon.addTransceiver('audio')
            }
        }

        get RTCPeerConnection() {
            return this.rtcCon
        }

        createOffer() {
            return this.rtcCon.createOffer({
                offerToReceiveAudio: false,
                offerToReceiveVideo: false
            })
        }

        createAnswer() {
            return this.rtcCon.createAnswer()
        }

        addCandidate(candidate) {
            if (!candidate) {
                return
            }

            if (!this.rtcCon.remoteDescription) {
                this.candidateBuf.push(candidate)
            } else {
                if (this.candidateBuf.length > 0) {
                    let list = this.candidateBuf
                    this.candidateBuf = []
                    list.forEach((candidate) => {
                        this.rtcCon.addIceCandidate(new RTCIceCandidate(candidate)).catch(console.error)
                    })
                }
                this.rtcCon.addIceCandidate(new RTCIceCandidate(candidate)).catch(console.error)
            }
        }



        logEvent() {
            return function (event) {
                console.info('EVENT', event.type, event.target)
            }
        }
    }

    function createCard(member) {
        let card = document.createElement('div')
        card.classList.add('card')
        card.classList.add('m-2')
        card.id = `card-${member.user_id}`
        card.style = 'width: 18rem;'

        let video = document.createElement('video')
        video.classList.add('card-img-top')
        video.autoplay = true
        video.muted = false
        video.id = `video-${member.user_id}`
        card.appendChild(video)

        let body = document.createElement('div')
        body.classList.add('card-body')
        body.innerHTML = `<h5 class="card-title">${member.name}</h5>
    <p class="card-text">${member.user_id}</p>`
        card.appendChild(body)
        return card
    }

    let cons = {}
    document.addEventListener('DOMContentLoaded', () => {

        let ws
        let conf
        let iam


        function onIceCandidateCallback(to) {
            return (e) => {
                ws.send({
                    cmd: "candidate",
                    params: {
                        to: to,
                        candidate: e.candidate
                    }
                })
            }
        }

        document.getElementById('btnConnect').addEventListener('click', () => {
            let url = document.getElementById('inpSignalingUrl').value + '?token=' + document.getElementById('inpToken').value
            ws = new signaling()
            ws.onMessage = (data) => {
                let memberId = data.member.user_id
                console.info("CONFIG", conf)
                switch (data.cmd) {
                    case "ice_servers":
                        conf = data.params
                        iam = data.member
                        console.info("I am", iam)
                        console.info("CONFIG", conf)
                        let iamCard = createCard(iam)
                        document.getElementById('localVideoContainer').appendChild(iamCard)
                        ws.send({
                            cmd: "join",
                            params: {}
                        })
                        break
                    case "start_stream":
                        navigator.mediaDevices.getUserMedia({video:true, audio:true}).then((stream) => {
                            document.getElementById("video-" + iam.user_id).muted = true
                            document.getElementById("video-" + iam.user_id).srcObject = stream
                            cons[memberId] = new rtcPC(data.member, conf, onIceCandidateCallback(memberId), () => {}, stream)
                            cons[memberId].createOffer().then((offer) => {
                                cons[memberId].RTCPeerConnection.setLocalDescription(offer).then(() => {
                                    console.info("set offer")
                                    ws.send({
                                        cmd: "offer",
                                        params: {
                                            offer: offer,
                                            to: memberId,
                                        }
                                    })
                                }).catch(console.error)
                            }).catch(console.error)
                        }).catch(console.error)
                        break
                    case "answer":
                        cons[memberId].RTCPeerConnection.setRemoteDescription(data.params.answer).catch(console.error)
                        break
                    case "candidate":
                        if (!cons.hasOwnProperty(memberId)) {
                            cons[memberId] = new rtcPC(data.member, conf, onIceCandidateCallback(memberId), (e) => {
                                console.warn("incoming track 111", e.streams[0], e.streams[0].getTracks())
                                let video = document.getElementById('video-'+memberId)
                                if (!video) {
                                    let card = createCard(data.member)
                                    document.getElementById("remoteVideoContainer").appendChild(card)
                                    video = document.getElementById('video-'+memberId)
                                }
                                video.srcObject = e.streams[0]

                                // let templ = document.createElement("div")
                                // templ.classList.add("col")
                                // let video = document.createElement("video")
                                // video.id=memberId
                                // video.width = 200
                                // video.height = 200
                                // video.autoplay = true
                                // video.muted = false
                                // video.srcObject = e.streams[0]
                                // templ.appendChild(video)
                                // let name = document.createElement('div')
                                // name.innerText = data.member.name
                                // templ.appendChild(name)
                                // let uid = document.createElement('div')
                                // uid.innerText = memberId
                                // templ.appendChild(uid)
                                // document.getElementById("remoteVideoContainer").appendChild(templ)
                                // document.getElementById("remoteVideoSrc").srcObject = e.streams[0]
                            })
                        }
                        cons[memberId].addCandidate(data.params.candidate)
                        break
                    case "offer":
                        if (!cons.hasOwnProperty(memberId)) {
                            cons[memberId] = new rtcPC(data.member, conf, onIceCandidateCallback(memberId), (e) => {
                                console.warn("incoming track 222", e.streams[0], e.streams[0].getTracks())
                                let video = document.getElementById('video-'+memberId)
                                if (!video) {
                                    let card = createCard(data.member)
                                    document.getElementById("remoteVideoContainer").appendChild(card)
                                    video = document.getElementById('video-'+memberId)
                                }
                                video.srcObject = e.streams[0]

                                // let templ = document.createElement("div")
                                // templ.classList.add("col")
                                // let video = document.createElement("video")
                                // video.id=memberId
                                // video.width = 200
                                // video.height = 200
                                // video.autoplay = true
                                // video.muted = false
                                // video.srcObject = e.streams[0]
                                // templ.appendChild(video)
                                // let name = document.createElement('div')
                                // name.innerText = data.member.name
                                // templ.appendChild(name)
                                // let uid = document.createElement('div')
                                // uid.innerText = memberId
                                // templ.appendChild(uid)
                                // document.getElementById("remoteVideoContainer").appendChild(templ)
                                // document.getElementById("remoteVideoSrc").srcObject = e.streams[0]
                            })
                        }
                        cons[memberId].RTCPeerConnection.setRemoteDescription(data.params.offer).then(() => {
                            console.log("offer accepted")
                            Promise.all(cons[memberId].candidateBuf.map(c => cons[memberId].RTCPeerConnection.addIceCandidate(new RTCIceCandidate(c)))).then(() => {
                                cons[memberId].createAnswer().then((answer) => {
                                    cons[memberId].RTCPeerConnection.setLocalDescription(answer).then(() => {
                                        ws.send({
                                            cmd: "answer",
                                            params: {
                                                answer: answer,
                                                to: memberId,
                                            }
                                        })

                                        // setInterval(() => {
                                        //     ws.send({
                                        //         cmd: "mic-muted",
                                        //         params: {
                                        //             to: memberId,
                                        //             state: false
                                        //         }
                                        //     })
                                        // }, 5000)
                                    }).catch((console.error))
                                }).catch(console.error)
                            }).catch(console.error)

                        }).catch(console.error)
                        break
                    case "leave":
                        let card = document.getElementById('card-'+memberId)
                        if (card) {
                            card.remove()
                        }
                        break
                }
            }
            ws.onSignalingSuccess = () => {
                console.log("WS connected")
                document.getElementById("containerConnection").classList.add("d-none")

                setInterval(() => {
                    for (let mid in cons) {
                        if (cons.hasOwnProperty(mid)) {
                            console.info('STATE', mid, cons[mid].rtcCon.connectionState)
                            let c = cons[mid].rtcCon
                            switch (cons[mid].rtcCon.connectionState) {
                                case 'closed':
                                case 'failed':
                                case 'disconnected':
                                    if (document.getElementById('card-' +mid)) {
                                        document.getElementById('card-' +mid).remove()
                                    }
                                    c.close()
                                    delete cons[mid]
                                    break
                            }
                        }
                    }
                }, 1000)

            }
            ws.onSignalingError = (err) => {
                console.error("WS error", err)
            }
            ws.connect(url)


        })
    })

</script>

</body>
</html>
